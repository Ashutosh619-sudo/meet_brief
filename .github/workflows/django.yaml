name: Django CI

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
    test_django_job:
      uses: Ashutosh619-sudo/meet_brief/.github/workflows/test-django.yaml@master
    
    build:
      runs-on: ubuntu-latest
      needs: [test_django_job]
      env:
        DJANGO_SECRET_KEY: nfikanfklsanfklnsalkfasfnlsfbklbnkjl
      steps:
        - name: Checkout code
          uses: actions/checkout@v2
        - name: Install doctl
          uses: digitalocean/action-doctl@v2
          with:
            token: ${{ secrets.DO_API_TOKEN_KEY }}
        - name: Login in to DO Container Registery with short-lived creds
          run: doctl registry login --expiry-seconds 1200
        - name: Build Container Image
          working-directory: .
          run: |
            docker build -f Dockerfile \
            -t registry.digitalocean.com/meet-brief/meet-brief-api:latest \
            -t registry.digitalocean.com/meet-brief/meet-brief-api:${GITHUB_SHA::7} \
            .
        - name: Push Image
          run: |
            docker push registry.digitalocean.com/meet-brief/meet-brief-api --all-tags